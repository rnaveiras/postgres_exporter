---
name: postgres_exporter
x-postgres: &postgres
  environment:
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_DB: postgres
  ports:
    - "5432:5432"
  command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U postgres"]
    interval: 5s
    timeout: 5s
    retries: 5
  networks:
    postgres_exporter:
      aliases:
        - postgres

x-network: &network
  networks:
    - postgres_exporter

services:
  postgres13:
    <<: *postgres
    image: postgres:13.22@sha256:9a41ba632f72722f4480663eef10d99a35f0e48b1835a6d1ccfc0b606497616d
    volumes:
      - postgres_data_13:/var/lib/postgresql/data
      - ./docker/postgresql.conf:/etc/postgresql/postgresql.conf
    profiles:
      - postgres13

  postgres14:
    <<: *postgres
    image: postgres:14.19@sha256:d35fe6e6bd8d17d66dc383e18f68ce73bc9772cd3121eaa96e2c7944fe17d337
    volumes:
      - postgres_data_14:/var/lib/postgresql/data
      - ./docker/postgresql.conf:/etc/postgresql/postgresql.conf
    profiles:
      - postgres14

  postgres15:
    <<: *postgres
    image: postgres:15.14@sha256:424e79b81868f5fc5cf515eaeac69d288692ebcca7db86d98f91b50d4bce64bb
    volumes:
      - postgres_data_15:/var/lib/postgresql/data
      - ./docker/postgresql.conf:/etc/postgresql/postgresql.conf
    profiles:
      - postgres15

  postgres16:
    <<: *postgres
    image: postgres:16.10@sha256:4eb532412200f7fbbf15d62ee0d96e020a9eae9eaed76066692474a7371c4d83
    volumes:
      - postgres_data_16:/var/lib/postgresql/data
      - ./docker/postgresql.conf:/etc/postgresql/postgresql.conf
    profiles:
      - postgres16

  postgres17:
    <<: *postgres
    image: postgres:17.6@sha256:b480430782a9bd1c8a6835fb5b70f89f34a70132c2f6182e534f65688bce063b
    volumes:
      - postgres_data_17:/var/lib/postgresql/data
      - ./docker/postgresql.conf:/etc/postgresql/postgresql.conf
    profiles:
      - postgres17

  postgres18:
    <<: *postgres
    image: postgres:18.0@sha256:1ffc019dae94eca6b09a49ca67d37398951346de3c3d0cfe23d8d4ca33da83fb
    volumes:
      - postgres_data_18:/var/lib/postgresql/data
      - ./docker/postgresql.conf:/etc/postgresql/postgresql.conf
    profiles:
      - postgres18

  prometheus:
    <<: *network
    image: quay.io/prometheus/prometheus:v3.7.2@sha256:23031bfe0e74a13004252caaa74eccd0d62b6c6e7a04711d5b8bf5b7e113adc7
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/docker/prometheus_data
    profiles:
      - default

  postgres-exporter:
    <<: *network
    build:
      context: .
    command:
      [
        "--log.level=debug",
        "--log.format=logfmt",
        "--db.excluded-databases=rdsadmin",
        "--db.excluded-databases=cloudsqladmin",
      ]
    entrypoint: ["/bin/postgres_exporter"]
    ports:
      - "9187:9187"
    environment:
      - PGHOST=postgres
      - PGUSER=postgres
      - PGPASSWORD=postgres
      - PGPGDATABASE=postgres
      - PGSSLMODE=disable
    profiles:
      - default

  grafana:
    <<: *network
    image: grafana/grafana:12.2.1@sha256:35c41e0fd0295f5d0ee5db7e780cf33506abfaf47686196f825364889dee878b
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning
      - ./docker/grafana/dashboards:/etc/grafana/dashboards
    depends_on:
      - prometheus
    profiles:
      - default

volumes:
  prometheus_data:
  grafana_data:
  postgres_data_13:
  postgres_data_14:
  postgres_data_15:
  postgres_data_16:
  postgres_data_17:
  postgres_data_18:

networks:
  postgres_exporter:
